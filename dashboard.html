<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>MACRO SIGNAL</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap');
:root{
  --bg:#060a0f;--sur:#0d1520;--bdr:#1e3048;
  --txt:#ffffff;--sub:#ccddf0;--mut:#7090a8;
  --red:#ff3344;--grn:#00e87a;--yel:#ffb830;--cyn:#00d4ff;
  --r:8px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{overflow-x:hidden}
body{
  background:var(--bg);color:var(--txt);
  font-family:'DM Sans',sans-serif;font-size:16px;
  background-image:
    radial-gradient(ellipse at 15% 0%,rgba(0,212,255,.12) 0%,transparent 45%),
    radial-gradient(ellipse at 85% 0%,rgba(0,232,122,.09) 0%,transparent 40%),
    radial-gradient(ellipse at 50% 100%,rgba(255,51,68,.07) 0%,transparent 50%);
}

/* ── HEADER ── */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 24px;border-bottom:1px solid rgba(30,48,72,.8);
  background:rgba(6,10,15,.9);position:sticky;top:0;z-index:200;
  backdrop-filter:blur(16px);
  box-shadow:0 1px 0 rgba(0,212,255,.08),0 4px 20px rgba(0,0,0,.5);
}
.logo{font-family:'Bebas Neue';font-size:26px;letter-spacing:5px;
  background:linear-gradient(135deg,var(--cyn),var(--grn));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo em{font-style:normal;font-size:13px;letter-spacing:2px;
  font-family:'Space Mono';margin-left:12px;
  -webkit-text-fill-color:var(--mut);color:var(--mut)}
#ts{font-family:'Space Mono';font-size:13px;color:var(--sub)}

/* ── LAYOUT ── */
.wrap{max-width:1520px;margin:0 auto;padding:16px 20px}
.sec{margin-bottom:16px}

/* ── CARD ── */
.card{
  background:linear-gradient(145deg,var(--sur),rgba(10,17,28,.97));
  border:1px solid var(--bdr);border-radius:var(--r);overflow:hidden;
  box-shadow:0 4px 20px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.04);
}
.ch{display:flex;align-items:center;justify-content:space-between;
  padding:12px 18px;border-bottom:1px solid rgba(30,48,72,.7);
  font-family:'Space Mono';font-size:12px;letter-spacing:2px;
  color:var(--sub);text-transform:uppercase;background:rgba(0,0,0,.2);
  flex-wrap:wrap;gap:6px}
.cb{padding:16px 18px}

/* ── TOP ROW (데스크탑: 3칸) ── */
.top-row{display:grid;grid-template-columns:1fr 1.6fr 1fr;gap:14px}

/* ── GAUGE ── */
.gauge-card-inner{padding:18px 16px 14px}
/* 데스크탑: 게이지 왼쪽, 바 오른쪽 */
.gauge-wrap{display:flex;align-items:flex-start;gap:16px}
.gauge{position:relative;width:140px;height:140px;flex-shrink:0}
.gauge svg{position:absolute;top:0;left:0;transform:rotate(-90deg)}
.gauge .trk{fill:none;stroke:rgba(30,48,72,.9);stroke-width:11}
.gauge .arc{fill:none;stroke-width:11;stroke-linecap:round;
  transition:stroke-dashoffset .9s cubic-bezier(.4,0,.2,1),stroke .3s;
  filter:drop-shadow(0 0 6px currentColor)}
/* 숫자 완벽 중앙 — position:absolute로 SVG 위에 정확히 올림 */
.gauge-center{
  position:absolute;top:0;left:0;width:100%;height:100%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  pointer-events:none;
}
.gauge-num{font-family:'Bebas Neue';font-size:56px;line-height:1}
.gauge-sub{font-family:'Space Mono';font-size:13px;color:var(--mut);margin-top:1px}
.gauge-bars{flex:1;min-width:0;padding-top:4px}

/* ── SIGNAL ── */
.sig{padding:9px 26px;border-radius:4px;font-family:'Bebas Neue';
  font-size:30px;letter-spacing:6px;margin-top:14px;text-align:center}
.sSELL{background:linear-gradient(135deg,#3a0810,#1a0408);
  color:var(--red);border:1px solid rgba(255,51,68,.5);box-shadow:0 0 18px rgba(255,51,68,.25)}
.sBUY{background:linear-gradient(135deg,#003820,#001f10);
  color:var(--grn);border:1px solid rgba(0,232,122,.5);box-shadow:0 0 18px rgba(0,232,122,.25)}
.sHOLD{background:linear-gradient(135deg,#002535,#001520);
  color:var(--cyn);border:1px solid rgba(0,212,255,.5);box-shadow:0 0 18px rgba(0,212,255,.25)}
.act{font-family:'Space Mono';font-size:13px;color:var(--sub);text-align:center;margin-top:8px}

/* PROB */
.prob-pair{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
.pbox{border-radius:6px;padding:14px;text-align:center}
.pbox-s{background:linear-gradient(135deg,#2a0810,#180408);border:1px solid rgba(255,51,68,.3)}
.pbox-b{background:linear-gradient(135deg,#003318,#001a0c);border:1px solid rgba(0,232,122,.3)}
.pbox-lbl{font-family:'Space Mono';font-size:11px;color:var(--sub);margin-bottom:6px}
.pbox-num{font-family:'Bebas Neue';font-size:44px;line-height:1}
.pbox-sub{font-family:'Space Mono';font-size:11px;color:var(--sub);margin-top:4px}
.pbox-n{font-family:'Space Mono';font-size:10px;color:var(--mut);margin-top:2px}

/* TABS */
.htabs{display:flex;gap:4px;margin:10px 0 8px;flex-wrap:wrap}
.htab{padding:6px 13px;font-family:'Space Mono';font-size:12px;
  border:1px solid var(--bdr);border-radius:3px;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .15s;touch-action:manipulation}
.htab.on{border-color:var(--cyn);color:var(--cyn);background:rgba(0,212,255,.12);
  box-shadow:0 0 6px rgba(0,212,255,.2)}
.htab:hover:not(.on){color:#fff}

.ttabs{display:flex;gap:5px;padding:10px 16px 0;flex-wrap:wrap}
.ttab{padding:7px 18px;font-family:'Space Mono';font-size:12px;
  border:1px solid var(--bdr);border-radius:3px;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .15s;touch-action:manipulation}
.ttab.on{border-color:var(--cyn);color:var(--cyn);background:rgba(0,212,255,.12)}
.ttab:hover:not(.on){color:#fff}

.slbl{font-family:'Space Mono';font-size:11px;letter-spacing:2px;
  color:var(--sub);text-transform:uppercase;margin-bottom:10px}

/* IND BARS */
.irow{display:flex;align-items:center;padding:7px 0;
  border-bottom:1px solid rgba(30,48,72,.4);gap:8px}
.irow:last-child{border-bottom:none}
.inm{font-family:'Space Mono';font-size:11px;color:var(--sub);
  width:150px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.itrk{flex:1;height:6px;background:rgba(30,48,72,.9);border-radius:3px;overflow:hidden}
.ifil{height:100%;border-radius:3px;transition:width .6s cubic-bezier(.4,0,.2,1)}
.ival{font-family:'Space Mono';font-size:13px;font-weight:700;width:36px;text-align:right;flex-shrink:0}
.ipct{font-family:'Space Mono';font-size:11px;color:var(--mut);width:36px;text-align:right;flex-shrink:0}

/* ── CHART TOOLBAR ── */
.chart-toolbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 18px;border-bottom:1px solid rgba(30,48,72,.5);
  gap:10px;flex-wrap:wrap;
}
.chart-toolbar-left{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.chart-title{font-family:'Bebas Neue';font-size:18px;letter-spacing:3px;color:var(--sub)}
.legend-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
.legend-row span{font-size:14px;display:flex;align-items:center;gap:6px;color:#fff}
.ldot{display:inline-block;width:10px;height:10px;border-radius:50%}

.chart-toolbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.range-btns{display:flex;gap:4px;flex-wrap:wrap}
.rbtn{padding:6px 14px;font-family:'Space Mono';font-size:12px;
  border:1px solid var(--bdr);border-radius:3px;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .15s;
  white-space:nowrap;touch-action:manipulation}
.rbtn.on{border-color:var(--cyn);color:var(--cyn);background:rgba(0,212,255,.12);
  box-shadow:0 0 6px rgba(0,212,255,.15)}
.rbtn:hover:not(.on){color:#fff}
.chart-actions{display:flex;gap:5px}
.cbtn{padding:6px 13px;font-family:'Space Mono';font-size:12px;
  border:1px solid var(--bdr);border-radius:3px;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .15s;touch-action:manipulation}
.cbtn:hover{color:#fff;border-color:rgba(255,255,255,.3)}

/* CANVAS */
.chart-canvas-wrap{position:relative;padding:12px 16px 8px;cursor:crosshair}
.chart-canvas-wrap:active{cursor:grabbing}

/* ── 마우스/터치 TOOLTIP ── */
#chart-tooltip{
  position:fixed;
  pointer-events:none;
  z-index:9999;
  display:none;
  min-width:190px;
  background:rgba(8,14,24,.97);
  border:1px solid rgba(30,48,72,.9);
  border-radius:6px;
  padding:10px 14px;
  box-shadow:0 8px 32px rgba(0,0,0,.7),0 0 0 1px rgba(0,212,255,.08);
  backdrop-filter:blur(8px);
}
.tt-date{
  font-family:'Space Mono';font-size:11px;color:var(--cyn);
  margin-bottom:8px;padding-bottom:6px;
  border-bottom:1px solid rgba(30,48,72,.8);letter-spacing:1px;
}
.tt-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:3px 0;gap:16px;
}
.tt-label{font-family:'Space Mono';font-size:11px;color:var(--mut)}
.tt-value{font-family:'Space Mono';font-size:12px;font-weight:700;white-space:nowrap}
.tt-sep{height:1px;background:rgba(30,48,72,.6);margin:6px 0}

/* INFO BAR */
.chart-info{
  display:flex;gap:20px;align-items:center;flex-wrap:wrap;
  padding:8px 18px;border-top:1px solid rgba(30,48,72,.4);
  min-height:38px;background:rgba(0,0,0,.15);
}
.ci{font-family:'Space Mono';font-size:13px;color:var(--sub)}
.ci span{font-weight:700;margin-left:4px}
.ci-empty{font-family:'Space Mono';font-size:12px;color:var(--mut)}

/* ── 크로스 전용 툴팁 ── */
#cross-tooltip{
  position:fixed;pointer-events:none;z-index:9100;display:none;
  min-width:255px;max-width:310px;
  background:rgba(5,10,18,.98);border-radius:8px;overflow:hidden;
  box-shadow:0 16px 48px rgba(0,0,0,.85),0 0 0 1px rgba(255,255,255,.07);
  backdrop-filter:blur(16px);
}
.ct-head{
  padding:11px 16px;font-family:'Bebas Neue';font-size:17px;letter-spacing:3px;
  display:flex;align-items:center;justify-content:space-between;
}
.ct-body{padding:10px 16px 14px}
.ct-row{display:flex;justify-content:space-between;align-items:baseline;
  padding:4px 0;font-family:'Space Mono';font-size:11px;}
.ct-lbl{color:var(--mut)}
.ct-val{font-weight:700}
.ct-sep{height:1px;background:rgba(30,48,72,.6);margin:8px 0}
.ct-stat{
  font-family:'Space Mono';font-size:10px;color:var(--sub);
  line-height:1.7;
  padding:8px 10px;border-radius:4px;
  background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);
}
.ct-warn{font-family:'Space Mono';font-size:10px;color:rgba(255,184,48,.7);margin-top:6px}

/* 파동 스프레드 테이블 */
.wave-wrap{border-bottom:1px solid rgba(30,48,72,.5)}
.wave-head{
  padding:10px 18px;background:rgba(0,212,255,.05);
  font-family:'Space Mono';font-size:11px;letter-spacing:2px;
  color:var(--cyn);text-transform:uppercase;
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;
}
.wave-head small{color:var(--mut);font-size:10px;text-transform:none;letter-spacing:0}
table.wtbl{width:100%;border-collapse:collapse;min-width:440px}
table.wtbl th{
  font-family:'Space Mono';font-size:11px;color:var(--mut);
  padding:8px 14px;border-bottom:1px solid rgba(30,48,72,.5);
  text-align:left;white-space:nowrap;background:rgba(0,0,0,.1);
}
table.wtbl td{padding:9px 14px;border-bottom:1px solid rgba(30,48,72,.2);
  font-family:'Space Mono';font-size:12px;white-space:nowrap;}
table.wtbl tr:last-child td{border-bottom:none}
table.wtbl tr.wbest td{background:rgba(0,212,255,.05)}
.wbadge{display:inline-block;padding:3px 9px;border-radius:3px;
  font-size:11px;font-family:'Space Mono';font-weight:700;}
.wnote{font-size:10px;color:var(--mut)}

/* ── 스크롤 가능한 테이블 래퍼 ── */
/* 4번 요청: 모든 표에 가로 스크롤 적용 */
.scroll{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  /* 스크롤바 꾸미기 */
  scrollbar-width:thin;
  scrollbar-color:rgba(30,48,72,.8) transparent;
}
.scroll::-webkit-scrollbar{height:4px}
.scroll::-webkit-scrollbar-track{background:transparent}
.scroll::-webkit-scrollbar-thumb{background:rgba(30,48,72,.9);border-radius:2px}

/* TABLES */
table.ht{border-collapse:collapse;min-width:520px}/* 최소 너비 → 스크롤 유도 */
table.ht th{font-family:'Space Mono';font-size:12px;letter-spacing:1px;
  text-transform:uppercase;color:var(--sub);padding:10px 12px;
  border-bottom:1px solid rgba(30,48,72,.7);text-align:left;white-space:nowrap}
table.ht td{padding:9px 12px;border-bottom:1px solid rgba(30,48,72,.3);
  font-family:'Space Mono';font-size:13px;font-weight:700;white-space:nowrap}
table.ht tr:last-child td{border-bottom:none}
table.ht tr:hover td{background:rgba(255,255,255,.025)}
.hcell{display:inline-block;padding:4px 10px;border-radius:3px;min-width:50px;text-align:center}

.ptbl{border-collapse:collapse;min-width:520px}
.ptbl th{font-family:'Space Mono';font-size:12px;text-transform:uppercase;
  color:var(--sub);padding:10px 12px;border-bottom:1px solid rgba(30,48,72,.7);
  text-align:left;white-space:nowrap}
.ptbl td{padding:9px 12px;border-bottom:1px solid rgba(30,48,72,.3);
  font-family:'Space Mono';font-size:13px;white-space:nowrap}
.ptbl tr:last-child td{border-bottom:none}
.ptbl tr:hover td{background:rgba(255,255,255,.02)}

/* POWER */
.prow{display:flex;align-items:center;padding:8px 0;
  border-bottom:1px solid rgba(30,48,72,.4);gap:8px}
.prow:last-child{border-bottom:none}
.pnm{font-family:'Space Mono';font-size:12px;color:var(--sub);
  width:180px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pbar-t{flex:1;height:6px;background:rgba(30,48,72,.9);border-radius:3px;overflow:hidden}
.pbar-f{height:100%;border-radius:3px;transition:width .5s}
.pval{font-family:'Space Mono';font-size:13px;font-weight:700;width:42px;text-align:right;flex-shrink:0}

.div{width:100%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(30,48,72,.9),transparent);margin:14px 0}

/* ══════════════════════
   MOBILE (768px 이하)
══════════════════════ */
@media(max-width:768px){
  body{font-size:15px}
  header{padding:12px 16px}
  .logo{font-size:22px}
  .logo em{display:none}
  #ts{font-size:11px}
  .wrap{padding:10px 12px}
  .sec{margin-bottom:12px}

  /* 2번 요청: 모바일 순서 → 시그널 맨 위, 매수, 매도 순 */
  /* grid 사용해서 order로 순서 변경 */
  .top-row{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  #card-sell{order:3}
  #card-center{order:1}
  #card-buy{order:2}

  /* 1번 요청: 게이지 겹침 해결 */
  /* 게이지를 위에, 바를 아래에 세로 배치 */
  .gauge-card-inner{padding:14px 16px 14px}
  .gauge-wrap{
    flex-direction:column;
    align-items:center;
    gap:12px;
  }
  .gauge{
    width:120px;height:120px;
    flex-shrink:0;
  }
  .gauge-num{font-size:44px}
  .gauge-sub{font-size:12px}
  .gauge-bars{
    width:100%;
    padding-top:0;
  }
  /* inm 너비 조정 */
  .inm{width:130px;font-size:10px}
  .ival{font-size:12px}
  .ipct{font-size:10px}

  /* 하단 그리드 1열 */
  .r3{grid-template-columns:1fr}

  /* 차트 툴바 */
  .chart-toolbar{padding:10px 12px;gap:6px}
  .chart-title{font-size:14px}
  .legend-row span{font-size:12px}
  .rbtn{padding:5px 10px;font-size:11px}
  .cbtn{padding:5px 10px;font-size:11px}
  .chart-canvas-wrap{padding:8px 10px 4px}

  /* info bar */
  .chart-info{gap:10px;padding:7px 12px;flex-direction:column;align-items:flex-start}
  .ci{font-size:12px}

  /* 테이블 */
  table.ht th,table.ht td{padding:7px 10px;font-size:12px}
  .ptbl th,.ptbl td{padding:7px 10px;font-size:12px}

  /* pbox */
  .pbox-num{font-size:38px}
  .pbox-lbl{font-size:10px}
}

@media(max-width:480px){
  /* 3M, 6M 숨김 */
  .range-btns .rbtn:nth-child(1),
  .range-btns .rbtn:nth-child(2){display:none}
  .gauge{width:110px;height:110px}
  .gauge-num{font-size:42px}
  .inm{width:110px}
}

.r3{display:grid;grid-template-columns:1fr 1fr;gap:14px}
</style>
</head>
<body>

<!-- 툴팁 -->
<div id="chart-tooltip"></div>
<div id="cross-tooltip"></div>

<header>
  <span class="logo">MACRO SIGNAL <em>DASHBOARD</em></span>
  <span id="ts">로드 중...</span>
</header>

<div class="wrap">

  <!-- TOP ROW: 데스크탑=SELL|CENTER|BUY / 모바일=CENTER,BUY,SELL 순 -->
  <div class="top-row sec">

    <!-- SELL (모바일에서 order:3) -->
    <div class="card" id="card-sell">
      <div class="ch">
        <span>매도 위험 점수</span>
        <span id="sell-tr" style="color:var(--red);font-size:14px">─</span>
      </div>
      <div class="gauge-card-inner">
        <div class="gauge-wrap">
          <div class="gauge">
            <svg viewBox="0 0 140 140" width="140" height="140">
              <circle class="trk" cx="70" cy="70" r="59"/>
              <circle class="arc" id="sell-arc" cx="70" cy="70" r="59"
                stroke-dasharray="370.7" stroke-dashoffset="370.7" stroke="var(--red)"/>
            </svg>
            <div class="gauge-center">
              <span class="gauge-num" id="sell-num" style="color:var(--red)">--</span>
              <span class="gauge-sub">/100</span>
            </div>
          </div>
          <div class="gauge-bars" id="sell-bars"></div>
        </div>
      </div>
    </div>

    <!-- CENTER (모바일에서 order:1) -->
    <div class="card" id="card-center">
      <div class="ch">
        <span>현재 시그널</span>
        <span id="sig-date" style="font-family:'Space Mono';font-size:12px;color:var(--sub)">--</span>
      </div>
      <div style="display:flex;flex-direction:column;align-items:center;padding:18px">
        <div class="sig sHOLD" id="sig-badge">HOLD</div>
        <div class="act" id="sig-act">--</div>
        <div class="div"></div>
        <div style="width:100%">
          <div class="slbl">PROBABILITY FORECAST — 과거 전수 적중률</div>
          <div class="htabs">
            <button class="htab on" onclick="setH(1)">1주</button>
            <button class="htab" onclick="setH(2)">2주</button>
            <button class="htab" onclick="setH(3)">3주</button>
            <button class="htab" onclick="setH(4)">4주</button>
            <button class="htab" onclick="setH(5)">5주</button>
            <button class="htab" onclick="setH(6)">6주</button>
            <button class="htab" onclick="setH(8)">8주</button>
          </div>
          <div id="prob-disp"></div>
        </div>
        <div class="div"></div>
        <div style="font-family:'Space Mono';font-size:12px;color:var(--sub);text-align:center">
          금요일 확인 → 다음 주 월요일 실행
        </div>
      </div>
    </div>

    <!-- BUY (모바일에서 order:2) -->
    <div class="card" id="card-buy">
      <div class="ch">
        <span>매수 안전 점수</span>
        <span id="buy-tr" style="color:var(--grn);font-size:14px">─</span>
      </div>
      <div class="gauge-card-inner">
        <div class="gauge-wrap">
          <div class="gauge">
            <svg viewBox="0 0 140 140" width="140" height="140">
              <circle class="trk" cx="70" cy="70" r="59"/>
              <circle class="arc" id="buy-arc" cx="70" cy="70" r="59"
                stroke-dasharray="370.7" stroke-dashoffset="370.7" stroke="var(--grn)"/>
            </svg>
            <div class="gauge-center">
              <span class="gauge-num" id="buy-num" style="color:var(--grn)">--</span>
              <span class="gauge-sub">/100</span>
            </div>
          </div>
          <div class="gauge-bars" id="buy-bars"></div>
        </div>
      </div>
    </div>

  </div><!-- /top-row -->

  <!-- MAIN CHART -->
  <div class="card sec">
    <div class="chart-toolbar">
      <div class="chart-toolbar-left">
        <span class="chart-title">S&amp;P 500 + MACRO SIGNALS</span>
        <div class="legend-row">
          <span><span class="ldot" style="background:var(--red)"></span>매도위험</span>
          <span><span class="ldot" style="background:var(--grn)"></span>매수안전</span>
          <span><span class="ldot" style="background:#6699cc"></span>S&amp;P500</span>
          <span><span class="ldot" style="background:rgba(0,212,255,.85);border:2px solid var(--cyn);box-shadow:0 0 5px var(--cyn)"></span>TYPE1↓</span>
          <span><span class="ldot" style="background:rgba(255,51,68,.85);border:2px solid var(--red);box-shadow:0 0 5px var(--red)"></span>TYPE2↑</span>
        </div>
      </div>
      <div class="chart-toolbar-right">
        <div class="range-btns" id="range-btns">
          <button class="rbtn" onclick="setRange(90,this)">3M</button>
          <button class="rbtn" onclick="setRange(180,this)">6M</button>
          <button class="rbtn" onclick="setRange(365,this)">1Y</button>
          <button class="rbtn" onclick="setRange(730,this)">2Y</button>
          <button class="rbtn" onclick="setRange(1825,this)">5Y</button>
          <button class="rbtn on" onclick="setRange(0,this)">ALL</button>
        </div>
        <div class="chart-actions">
          <button class="cbtn" onclick="zoomIn()">＋</button>
          <button class="cbtn" onclick="zoomOut()">－</button>
          <button class="cbtn" onclick="resetZoom()">↺</button>
        </div>
      </div>
    </div>
    <div class="chart-canvas-wrap" id="chart-canvas-wrap">
      <canvas id="mc" height="190"></canvas>
    </div>
    <div class="chart-info" id="chart-info">
      <span class="ci-empty">차트 위에 마우스/터치를 올리면 상세 데이터가 표시됩니다</span>
    </div>
  </div>

  <!-- 적중률 + 예측력 -->
  <div class="r3 sec">
    <div class="card">
      <!-- ★ 파동 스프레드 테이블 -->
      <div class="wave-wrap">
        <div class="wave-head">
          ⚡ TYPE1 크로스 — 파동 최대 스프레드별 8주 성과
          <small>1986~현재 전수분석</small>
        </div>
        <div class="scroll">
          <table class="wtbl">
            <thead>
              <tr>
                <th>구간 최대 스프레드</th>
                <th>8주 평균수익</th>
                <th>상승확률</th>
                <th>샘플</th>
                <th>평가</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="color:var(--sub)">0 ~ 10pt</td>
                <td style="color:var(--grn);font-weight:700">+3.2%</td>
                <td><span class="wbadge" style="background:rgba(0,232,122,.12);color:var(--grn);border:1px solid rgba(0,232,122,.3)">87.5%</span></td>
                <td class="wnote">n=8</td>
                <td class="wnote" style="color:var(--yel)">샘플 너무 적음</td>
              </tr>
              <tr>
                <td style="color:var(--sub)">10 ~ 20pt</td>
                <td style="color:var(--mut);font-weight:700">+0.6%</td>
                <td><span class="wbadge" style="background:rgba(255,51,68,.12);color:var(--red);border:1px solid rgba(255,51,68,.3)">45.8%</span></td>
                <td class="wnote">n=24</td>
                <td class="wnote" style="color:var(--red)">노이즈 ⚠️</td>
              </tr>
              <tr class="wbest">
                <td style="color:#fff;font-weight:700">20 ~ 30pt</td>
                <td style="color:var(--grn);font-weight:700">+3.4%</td>
                <td><span class="wbadge" style="background:rgba(0,212,255,.18);color:var(--cyn);border:1px solid rgba(0,212,255,.5)">85.2% ✅</span></td>
                <td class="wnote" style="color:var(--sub)">n=27</td>
                <td class="wnote" style="color:var(--cyn)">최적 구간 ★</td>
              </tr>
              <tr>
                <td style="color:var(--sub)">30 ~ 40pt</td>
                <td style="color:var(--grn);font-weight:700">+2.5%</td>
                <td><span class="wbadge" style="background:rgba(0,232,122,.12);color:var(--grn);border:1px solid rgba(0,232,122,.3)">81.2%</span></td>
                <td class="wnote">n=16</td>
                <td class="wnote" style="color:var(--grn)">양호</td>
              </tr>
              <tr>
                <td style="color:var(--sub)">40 ~ 60pt</td>
                <td style="color:var(--grn);font-weight:700">+2.9%</td>
                <td><span class="wbadge" style="background:rgba(0,232,122,.12);color:var(--grn);border:1px solid rgba(0,232,122,.3)">75.0%</span></td>
                <td class="wnote">n=20</td>
                <td class="wnote" style="color:var(--grn)">양호</td>
              </tr>
              <tr>
                <td style="color:var(--sub)">60pt 이상</td>
                <td style="color:var(--red);font-weight:700">-1.3%</td>
                <td><span class="wbadge" style="background:rgba(255,51,68,.12);color:var(--red);border:1px solid rgba(255,51,68,.3)">58.3%</span></td>
                <td class="wnote">n=12</td>
                <td class="wnote" style="color:var(--red)">극단위기 — 함정</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="ch">
        <span>점수구간별 적중률</span>
        <span style="font-size:11px">1970년대~ 전수분석</span>
      </div>
      <div class="ttabs">
        <button class="ttab on" onclick="setType('sell')">매도</button>
        <button class="ttab" onclick="setType('buy')">매수</button>
      </div>
      <!-- 4번 요청: scroll 클래스로 가로 스크롤 -->
      <div class="cb" style="padding-top:12px">
        <div class="scroll"><div id="prob-tbl"></div></div>
      </div>
    </div>
    <div class="card">
      <div class="ch">
        <span>지표별 예측력 순위</span>
        <span style="color:var(--sub);font-size:11px">4주후 기준</span>
      </div>
      <div class="cb" style="padding-top:10px">
        <div id="pow-list"></div>
      </div>
    </div>
  </div>

  <!-- 히트맵 -->
  <div class="card sec">
    <div class="ch">
      <span>적중률 히트맵</span>
      <span style="color:var(--sub);font-size:11px">과거 전수 데이터 기반</span>
    </div>
    <div class="cb">
      <div class="slbl">▼ SELL 위험점수 → N주 후 하락(-2%↓) 확률</div>
      <!-- 4번 요청: 히트맵도 가로 스크롤 -->
      <div class="scroll" id="sell-hm"></div>
      <div style="height:20px"></div>
      <div class="slbl">▼ BUY 안전점수 → N주 후 상승(+2%↑) 확률</div>
      <div class="scroll" id="buy-hm"></div>
    </div>
  </div>

</div><!-- /wrap -->

<script>
let D=null, H=1, PT='sell', MC=null;
let ALL_LABELS=[], ALL_PRICES=[], ALL_SELL=[], ALL_BUY=[], ALL_TL_MAP={};
let maxP=1;
const CL=370.7;

/* ── 크로스/파동 ── */
let CROSSES=[];       // 전체 크로스 목록
let CROSS_MAP={};     // date → cross info
let WAVE_HL=null;     // {start,end} 현재 강조 파동
let crossTipOn=false;

/* TYPE1 파동 스프레드별 통계 (하드코딩) */
const WAVE_BANDS=[
  {lo:0,  hi:10,  avg:+3.2, up:87.5, n:8,  label:'0~10pt',  note:'샘플 적음',      nc:'#ffb830'},
  {lo:10, hi:20,  avg:+0.6, up:45.8, n:24, label:'10~20pt', note:'노이즈 ⚠️',      nc:'#ff3344'},
  {lo:20, hi:30,  avg:+3.4, up:85.2, n:27, label:'20~30pt', note:'최적 구간 ★',    nc:'#00d4ff'},
  {lo:30, hi:40,  avg:+2.5, up:81.2, n:16, label:'30~40pt', note:'양호',            nc:'#00e87a'},
  {lo:40, hi:60,  avg:+2.9, up:75.0, n:20, label:'40~60pt', note:'양호',            nc:'#00e87a'},
  {lo:60, hi:999, avg:-1.3, up:58.3, n:12, label:'60pt+',   note:'극단위기 — 함정', nc:'#ff3344'},
];
function getBand(ms){ return WAVE_BANDS.find(b=>ms>=b.lo&&ms<b.hi)||WAVE_BANDS[WAVE_BANDS.length-1]; }

async function init(){
  try{
    const r=await fetch('dashboard_data.json');
    D=await r.json(); render();
  }catch(e){
    document.querySelector('.wrap').innerHTML=
      '<div style="display:flex;align-items:center;justify-content:center;height:260px;'+
      'flex-direction:column;gap:14px;font-family:Space Mono;font-size:13px">'+
      '<div style="color:#ff3344;font-size:15px">dashboard_data.json 없음</div>'+
      '<div style="color:#7090a8">python build_dashboard_data.py 를 먼저 실행하세요</div></div>';
  }
}

function render(){
  document.getElementById('ts').textContent=(D.generated_at||'').slice(0,16).replace('T',' ');
  gauges(D.current);
  signal(D.current);
  buildChartData();
  computeCrosses();
  mainChart();
  probTable();
  powList(D.indicator_stats);
  heatmaps(D.hit_rates);
}

/* ── GAUGES ── */
function gauges(cur){
  const sell=cur.sell_score||0, buy=cur.buy_score||0;
  const sc=sell>=72?'var(--red)':sell>=58?'var(--yel)':'var(--cyn)';
  const bc=buy>=65?'var(--grn)':buy>=45?'var(--cyn)':'var(--mut)';
  setGauge('sell-num','sell-arc',sell,sc);
  setGauge('buy-num','buy-arc',buy,bc);
  const tl=D.timeline;
  if(tl&&tl.length>=5){
    const ps=tl[tl.length-5]?.sell||0, cs=tl[tl.length-1]?.sell||0;
    document.getElementById('sell-tr').textContent=cs>ps?'▲ 상승':cs<ps?'▼ 하락':'─ 보합';
    const pb=tl[tl.length-5]?.buy||0, cb=tl[tl.length-1]?.buy||0;
    document.getElementById('buy-tr').textContent=cb>pb?'▲ 상승':cb<pb?'▼ 하락':'─ 보합';
  }
  indBars('sell-bars',cur.sell_detail,'sell');
  indBars('buy-bars', cur.buy_detail, 'buy');
}
function setGauge(numId,arcId,val,col){
  document.getElementById(numId).textContent=Math.round(val);
  document.getElementById(numId).style.color=col;
  const a=document.getElementById(arcId);
  a.style.strokeDashoffset=CL-(CL*val/100);
  a.style.stroke=col;
}
function indBars(id,items,t){
  const el=document.getElementById(id); if(!el||!items) return;
  el.innerHTML=items.slice(0,6).map(d=>{
    const v=t==='sell'?d.danger:(d.safety||d.contrib||0);
    const c=v>75?'var(--red)':v>55?'var(--yel)':'var(--grn)';
    const gw=v>75?'rgba(255,51,68,.45)':v>55?'rgba(255,184,48,.4)':'rgba(0,232,122,.35)';
    return `<div class="irow">
      <div class="inm" title="${d.indicator}">${d.indicator.replace(/_/g,' ')}</div>
      <div class="itrk"><div class="ifil" style="width:${v}%;background:${c};box-shadow:0 0 6px ${gw}"></div></div>
      <div class="ival" style="color:${c}">${Math.round(v)}</div>
      <div class="ipct">${d.percentile}%</div>
    </div>`;
  }).join('');
}

/* ── SIGNAL ── */
function signal(cur){
  const b=document.getElementById('sig-badge');
  b.textContent=cur.signal; b.className='sig s'+cur.signal;
  document.getElementById('sig-act').textContent=cur.action;
  document.getElementById('sig-date').textContent=cur.date;
  probDisp();
}
function setH(h){
  H=h;
  document.querySelectorAll('.htab').forEach((t,i)=>
    t.classList.toggle('on',[1,2,3,4,5,6,8][i]===h));
  probDisp();
}
function setType(t){
  PT=t;
  document.querySelectorAll('.ttab').forEach((el,i)=>
    el.classList.toggle('on',['sell','buy'][i]===t));
  probTable();
}
function findBand(bands,score){
  return bands.find(b=>score>=b.lo&&score<b.hi)||bands[bands.length-1];
}
function probDisp(){
  if(!D) return;
  const sell=D.current.sell_score||0, buy=D.current.buy_score||0;
  const hr=D.hit_rates, h=H;
  const sb=hr?.sell?.[h]||hr?.sell?.['1']||[];
  const bb=hr?.buy?.[h]||hr?.buy?.['1']||[];
  const sB=findBand(sb,sell), bB=findBand(bb,buy);
  const dn=sB?.down_prob, up=bB?.up_prob;
  const dnR=sB?.avg_ret, upR=bB?.avg_ret;
  const dc=dn>60?'var(--red)':dn>45?'var(--yel)':'var(--grn)';
  const uc=up>60?'var(--grn)':up>45?'var(--cyn)':'var(--mut)';
  document.getElementById('prob-disp').innerHTML=`
    <div class="prob-pair">
      <div class="pbox pbox-s">
        <div class="pbox-lbl">${h}주 후 하락 확률</div>
        <div class="pbox-num" style="color:${dc}">${dn!=null?dn.toFixed(1)+'%':'--'}</div>
        <div class="pbox-sub">${dnR!=null?'avg '+dnR.toFixed(1)+'%':''}</div>
        <div class="pbox-n">n=${sB?.n||0}</div>
      </div>
      <div class="pbox pbox-b">
        <div class="pbox-lbl">${h}주 후 상승 확률</div>
        <div class="pbox-num" style="color:${uc}">${up!=null?up.toFixed(1)+'%':'--'}</div>
        <div class="pbox-sub">${upR!=null?'avg '+upR.toFixed(1)+'%':''}</div>
        <div class="pbox-n">n=${bB?.n||0}</div>
      </div>
    </div>`;
}

/* ── CHART DATA ── */
function buildChartData(){
  const sp=D.sp_chart, tl=D.timeline;
  ALL_TL_MAP={};
  tl.forEach(t=>{ ALL_TL_MAP[t.date]=t; });
  ALL_LABELS=sp.map(d=>d.date);
  ALL_PRICES=sp.map(d=>d.price);
  ALL_SELL  =sp.map(d=>ALL_TL_MAP[d.date]?.sell??null);
  ALL_BUY   =sp.map(d=>ALL_TL_MAP[d.date]?.buy ??null);
  maxP=Math.max(...ALL_PRICES.filter(Boolean));
}

/* ── 크로스 & 파동 계산 ── */
function computeCrosses(){
  CROSSES=[]; CROSS_MAP={};
  const n=ALL_LABELS.length, raw=[];
  for(let i=1;i<n;i++){
    const sp=ALL_SELL[i-1]-ALL_BUY[i-1], sc=ALL_SELL[i]-ALL_BUY[i];
    if(sp==null||sc==null||isNaN(sp)||isNaN(sc)) continue;
    if(sp*sc<0) raw.push({idx:i, type:sp>0?1:2, date:ALL_LABELS[i]});
  }
  raw.forEach((c,ci)=>{
    const prev=ci>0?raw[ci-1].idx:0;
    let ms=0;
    for(let k=prev;k<c.idx;k++){
      const s=ALL_SELL[k],b=ALL_BUY[k];
      if(s!=null&&b!=null){ const d=Math.abs(s-b); if(d>ms) ms=d; }
    }
    const info={idx:c.idx, type:c.type, date:c.date, maxSpread:Math.round(ms),
                waveStart:prev, waveEnd:c.idx};
    CROSSES.push(info); CROSS_MAP[c.date]=info;
  });
}

/* ── 크로스 전용 툴팁 ── */
function showCrossTip(cx, cy, info){
  const tip=document.getElementById('cross-tooltip');
  const {type:t, date, maxSpread:ms, waveStart:ws, waveEnd:we}=info;
  const hc=t===1?'#00d4ff':'#ff3344';
  const hb=t===1?'rgba(0,212,255,.1)':'rgba(255,51,68,.1)';
  const label=t===1?'TYPE 1 크로스 ↓':'TYPE 2 크로스 ↑';

  let body='';
  if(t===1){
    const band=getBand(ms);
    const ac=band.avg>=0?'#00e87a':'#ff3344';
    const uc=band.up>=75?'#00e87a':band.up>=60?'#00d4ff':'#ffb830';
    body=`
      <div class="ct-row">
        <span class="ct-lbl">파동 최대 스프레드</span>
        <span class="ct-val" style="color:${hc}">${ms}pt <span style="color:var(--mut);font-weight:400">(${band.label})</span></span>
      </div>
      <div class="ct-row">
        <span class="ct-lbl">8주 후 평균수익</span>
        <span class="ct-val" style="color:${ac}">${band.avg>=0?'+':''}${band.avg}%</span>
      </div>
      <div class="ct-row">
        <span class="ct-lbl">8주 후 상승확률</span>
        <span class="ct-val" style="color:${uc}">${band.up}%</span>
      </div>
      <div class="ct-sep"></div>
      <div class="ct-stat">
        과거 <strong>${band.n}회</strong> 중 <strong>${Math.round(band.n*band.up/100)}회</strong> 8주 후 상승<br>
        이 구간: <strong style="color:${band.nc}">${band.note}</strong>
      </div>
      <div class="ct-warn">⚠ 틀릴 때는 -10~17% 가능 (위기 지속 시)</div>`;
  } else {
    body=`
      <div class="ct-row">
        <span class="ct-lbl">파동 최대 스프레드</span>
        <span class="ct-val" style="color:${hc}">${ms}pt</span>
      </div>
      <div class="ct-sep"></div>
      <div class="ct-stat" style="color:var(--mut)">TYPE2는 단기 하락 신호지만 통계적 유의성이 낮아 참고용으로만 활용하세요.</div>`;
  }

  tip.innerHTML=`
    <div class="ct-head" style="background:${hb};border-bottom:1px solid rgba(255,255,255,.06)">
      <span style="color:${hc}">${label}</span>
      <span style="font-family:'Space Mono';font-size:10px;color:var(--mut)">${date}</span>
    </div>
    <div class="ct-body">${body}</div>`;
  tip.style.display='block';
  crossTipOn=true;

  const tw=tip.offsetWidth||260, th2=tip.offsetHeight||200;
  const vw=window.innerWidth, vh=window.innerHeight;
  let lx=cx+18, ly=cy-20;
  if(lx+tw>vw-10) lx=cx-tw-14;
  if(ly+th2>vh-10) ly=vh-th2-10;
  if(ly<10) ly=10;
  tip.style.left=lx+'px'; tip.style.top=ly+'px';
}
function hideCrossTip(){
  document.getElementById('cross-tooltip').style.display='none';
  crossTipOn=false;
  if(WAVE_HL){ WAVE_HL=null; if(MC) MC.update('none'); }
}

/* ── TOOLTIP ── */
let tooltipVisible=false;

function showTooltip(x, y, idx){
  const tip=document.getElementById('chart-tooltip');
  const price=ALL_PRICES[idx];
  const sell=ALL_SELL[idx];
  const buy=ALL_BUY[idx];
  const date=ALL_LABELS[idx]||'';
  const tlData=ALL_TL_MAP[date];

  const sc=sell>=72?'#ff3344':sell>=58?'#ffb830':'#00d4ff';
  const bc=buy>=65?'#00e87a':buy>=45?'#00d4ff':'#7090a8';

  let indRows='';
  if(tlData?.sell_contributions){
    const sorted=Object.entries(tlData.sell_contributions)
      .sort((a,b)=>b[1]-a[1]).slice(0,4);
    if(sorted.length>0){
      indRows+=`<div class="tt-sep"></div>`;
      sorted.forEach(([k,v])=>{
        const col=v>10?'#ff3344':v>6?'#ffb830':'#7090a8';
        indRows+=`<div class="tt-row">
          <span class="tt-label">${k.replace(/_/g,' ')}</span>
          <span class="tt-value" style="color:${col}">${v.toFixed(1)}</span>
        </div>`;
      });
    }
  }

  tip.innerHTML=`
    <div class="tt-date">${date}</div>
    <div class="tt-row">
      <span class="tt-label">S&amp;P 500</span>
      <span class="tt-value" style="color:#6699cc">$${price?.toLocaleString()||'--'}</span>
    </div>
    <div class="tt-row">
      <span class="tt-label">매도 위험점수</span>
      <span class="tt-value" style="color:${sc}">${sell!=null?sell.toFixed(1):'--'}</span>
    </div>
    <div class="tt-row">
      <span class="tt-label">매수 안전점수</span>
      <span class="tt-value" style="color:${bc}">${buy!=null?buy.toFixed(1):'--'}</span>
    </div>
    ${indRows}`;

  tip.style.display='block';
  tooltipVisible=true;

  const tw=tip.offsetWidth||200, th=tip.offsetHeight||160;
  const vw=window.innerWidth, vh=window.innerHeight;
  let lx=x+18, ly=y-20;
  if(lx+tw>vw-10) lx=x-tw-14;
  if(ly+th>vh-10) ly=vh-th-10;
  if(ly<10) ly=10;
  tip.style.left=lx+'px';
  tip.style.top=ly+'px';
}

function hideTooltip(){
  document.getElementById('chart-tooltip').style.display='none';
  tooltipVisible=false;
}

/* 3번 요청: 차트 바깥 터치/클릭 시 툴팁 숨기기 */
document.addEventListener('touchstart', function(e){
  if(!tooltipVisible&&!crossTipOn) return;
  const canvas=document.getElementById('mc');
  const tip=document.getElementById('chart-tooltip');
  const ctip=document.getElementById('cross-tooltip');
  if(!canvas.contains(e.target)&&!tip.contains(e.target)&&!ctip.contains(e.target)){
    hideTooltip(); hideCrossTip();
    document.getElementById('chart-info').innerHTML=
      '<span class="ci-empty">차트 위에 마우스/터치를 올리면 상세 데이터가 표시됩니다</span>';
  }
},{passive:true});

document.addEventListener('click', function(e){
  if(!tooltipVisible&&!crossTipOn) return;
  const canvas=document.getElementById('mc');
  const tip=document.getElementById('chart-tooltip');
  const ctip=document.getElementById('cross-tooltip');
  if(!canvas.contains(e.target)&&!tip.contains(e.target)&&!ctip.contains(e.target)){
    hideTooltip(); hideCrossTip();
    document.getElementById('chart-info').innerHTML=
      '<span class="ci-empty">차트 위에 마우스/터치를 올리면 상세 데이터가 표시됩니다</span>';
  }
});

/* ── MAIN CHART ── */
function mainChart(){
  const ctx=document.getElementById('mc').getContext('2d');
  const pNorm=ALL_PRICES.map(p=>p?(p/maxP*100):null);
  const grad=ctx.createLinearGradient(0,0,0,190);
  grad.addColorStop(0,'rgba(102,153,204,.28)');
  grad.addColorStop(1,'rgba(102,153,204,.01)');

  /* 크로스 점 데이터: y2=50 고정으로 항상 잘 보이게 */
  const c1pts=new Array(ALL_LABELS.length).fill(null);
  const c2pts=new Array(ALL_LABELS.length).fill(null);
  CROSSES.forEach(cx=>{
    const i=ALL_LABELS.indexOf(cx.date);
    if(i<0) return;
    if(cx.type===1) c1pts[i]=50;
    else            c2pts[i]=50;
  });

  /* 오버레이 플러그인: 위기 음영 + 파동 굵은 선 하이라이트 */
  const overlayPlugin={id:'overlay', beforeDatasetsDraw(chart){
    const{ctx:c,chartArea:{left,right,top,bottom},scales:{x,y2}}=chart;
    c.save();

    /* 1) 위기 음영 (매도≥72) */
    let inE=false,sx=0;
    ALL_SELL.forEach((v,i)=>{
      try{
        const xp=x.getPixelForValue(i);
        if(v>=72&&!inE){inE=true;sx=xp;}
        if((v==null||v<72)&&inE){
          const eg=c.createLinearGradient(sx,0,xp,0);
          eg.addColorStop(0,'rgba(255,51,68,.0)');
          eg.addColorStop(.5,'rgba(255,51,68,.12)');
          eg.addColorStop(1,'rgba(255,51,68,.0)');
          c.fillStyle=eg; c.fillRect(sx,top,xp-sx,bottom-top); inE=false;
        }
      }catch(e){}
    });
    if(inE){c.fillStyle='rgba(255,51,68,.1)';c.fillRect(sx,top,right-sx,bottom-top);}

    /* 2) 파동 하이라이트 */
    if(WAVE_HL){
      const{start,end}=WAVE_HL;
      try{
        const x1=x.getPixelForValue(start), x2=x.getPixelForValue(end);
        /* 배경 */
        c.fillStyle='rgba(255,255,255,.05)';
        c.fillRect(x1,top,x2-x1,bottom-top);
        /* 점선 테두리 */
        c.strokeStyle='rgba(255,255,255,.2)';
        c.lineWidth=1; c.setLineDash([4,3]);
        c.strokeRect(x1,top,x2-x1,bottom-top);
        c.setLineDash([]);
        /* 굵은 매도선 */
        c.beginPath(); c.strokeStyle='rgba(255,51,68,1)'; c.lineWidth=3.5;
        let first=true;
        for(let i=start;i<=end;i++){
          if(ALL_SELL[i]==null) continue;
          const px=x.getPixelForValue(i), py=y2.getPixelForValue(ALL_SELL[i]);
          first?(c.moveTo(px,py),first=false):c.lineTo(px,py);
        }
        c.stroke();
        /* 굵은 매수선 */
        c.beginPath(); c.strokeStyle='rgba(0,232,122,1)'; c.lineWidth=3.5;
        first=true;
        for(let i=start;i<=end;i++){
          if(ALL_BUY[i]==null) continue;
          const px=x.getPixelForValue(i), py=y2.getPixelForValue(ALL_BUY[i]);
          first?(c.moveTo(px,py),first=false):c.lineTo(px,py);
        }
        c.stroke();
      }catch(e){}
    }
    c.restore();
  }};

  if(MC) MC.destroy();
  MC=new Chart(ctx,{
    type:'line', plugins:[overlayPlugin],
    data:{labels:ALL_LABELS, datasets:[
      {label:'SP500', data:pNorm,
       borderColor:'rgba(102,153,204,.9)', backgroundColor:grad,
       borderWidth:2.5, pointRadius:0, tension:.4, fill:true, yAxisID:'y'},
      {label:'매도', data:ALL_SELL,
       borderColor:'rgba(255,51,68,.95)', backgroundColor:'transparent',
       borderWidth:2, pointRadius:0, tension:.3, yAxisID:'y2'},
      {label:'매수', data:ALL_BUY,
       borderColor:'rgba(0,232,122,.95)', backgroundColor:'transparent',
       borderWidth:2, pointRadius:0, tension:.3, yAxisID:'y2'},
      /* TYPE1 크로스 점 (청록, y2=50 고정) */
      {label:'TYPE1', data:c1pts, type:'scatter',
       backgroundColor:'rgba(0,212,255,.85)', borderColor:'#00d4ff', borderWidth:2,
       pointRadius:8, pointHoverRadius:11, pointStyle:'circle', yAxisID:'y2'},
      /* TYPE2 크로스 점 (붉은, y2=50 고정) */
      {label:'TYPE2', data:c2pts, type:'scatter',
       backgroundColor:'rgba(255,51,68,.85)', borderColor:'#ff3344', borderWidth:2,
       pointRadius:8, pointHoverRadius:11, pointStyle:'circle', yAxisID:'y2'},
    ]},
    options:{
      responsive:true,
      interaction:{mode:'index',intersect:false},
      animation:{duration:400},
      plugins:{
        legend:{display:false},
        tooltip:{
          enabled:false,
          external(c2){
            if(c2.tooltip.opacity===0) return;
            if(crossTipOn) return;
            const idx=c2.tooltip.dataPoints[0]?.dataIndex; if(idx==null) return;
            const p=ALL_PRICES[idx], s=ALL_SELL[idx], b=ALL_BUY[idx];
            const sc=s>=72?'var(--red)':s>=58?'var(--yel)':'var(--cyn)';
            const bc=b>=65?'var(--grn)':b>=45?'var(--cyn)':'var(--mut)';
            document.getElementById('chart-info').innerHTML=`
              <div class="ci">날짜<span>${ALL_LABELS[idx]}</span></div>
              <div class="ci">S&amp;P500<span style="color:#6699cc">$${p?.toLocaleString()||'--'}</span></div>
              <div class="ci">매도위험<span style="color:${sc}">${s?.toFixed(1)||'--'}</span></div>
              <div class="ci">매수안전<span style="color:${bc}">${b?.toFixed(1)||'--'}</span></div>`;
          }
        },
        zoom:{
          zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x',onZoom(){clearRangeBtns();}},
          pan:{enabled:true,mode:'x',onPan(){clearRangeBtns();}},
          limits:{x:{minRange:8}},
        }
      },
      scales:{
        x:{ticks:{font:{family:'Space Mono',size:10},color:'#7090a8',
            maxTicksLimit:14,
            callback:function(val,i){
              try{
                const lbl=this.getLabelForValue(val);
                return lbl?lbl.slice(0,7):'';
              }catch(e){return '';}
            }},
           grid:{color:'rgba(30,48,72,.4)'}},
        y:{position:'right',ticks:{font:{family:'Space Mono',size:10},color:'#7090a8',
            callback:v=>`$${(v/100*maxP/1000).toFixed(0)}k`},grid:{display:false}},
        y2:{min:0,max:100,ticks:{font:{family:'Space Mono',size:10},color:'#7090a8',stepSize:25},
            grid:{color:'rgba(30,48,72,.4)'},border:{dash:[5,5]}}
      },
      onHover:(e,els,chart)=>{
        if(!e.native) return;
        /* 크로스 점 위에 있는지 먼저 확인 (dataset 3,4) */
        const cEls=chart.getElementsAtEventForMode(e.native,'nearest',{intersect:true},true)
                        .filter(el=>el.datasetIndex>=3);
        if(cEls.length>0){
          const idx=cEls[0].index;
          const info=CROSS_MAP[ALL_LABELS[idx]];
          if(info){
            WAVE_HL={start:info.waveStart, end:info.waveEnd};
            MC.update('none');
            showCrossTip(e.native.clientX, e.native.clientY, info);
            hideTooltip();
            return;
          }
        }
        /* 크로스 점 아닌 곳 */
        if(crossTipOn){ hideCrossTip(); }
        const pts=chart.getElementsAtEventForMode(e.native,'index',{intersect:false},true);
        if(pts.length===0){
          if(e.native.type==='mousemove'||e.native.type==='mouseout') hideTooltip();
          return;
        }
        showTooltip(e.native.clientX, e.native.clientY, pts[0].index);
      }
    }
  });

  /* mouseleave */
  document.getElementById('mc').addEventListener('mouseleave',()=>{
    hideTooltip(); hideCrossTip();
  });

  /* 모바일 터치: 크로스 점 탭 */
  document.getElementById('mc').addEventListener('touchend',function(e){
    e.preventDefault();
    const touch=e.changedTouches[0];
    const rect=this.getBoundingClientRect();
    const fake={clientX:touch.clientX, clientY:touch.clientY,
                offsetX:touch.clientX-rect.left, offsetY:touch.clientY-rect.top, target:this};
    const cEls=MC.getElementsAtEventForMode(fake,'nearest',{intersect:true},true)
                  .filter(el=>el.datasetIndex>=3);
    if(cEls.length>0){
      const idx=cEls[0].index;
      const info=CROSS_MAP[ALL_LABELS[idx]];
      if(info){
        WAVE_HL={start:info.waveStart, end:info.waveEnd};
        MC.update('none');
        showCrossTip(touch.clientX, touch.clientY, info);
        hideTooltip(); return;
      }
    }
    /* 일반 터치 */
    const pts=MC.getElementsAtEventForMode(fake,'index',{intersect:false},true);
    if(pts.length>0) showTooltip(touch.clientX, touch.clientY, pts[0].index);
  },{passive:false});
}

function setRange(days,btn){
  document.querySelectorAll('.rbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  if(days===0){MC?.resetZoom();return;}
  const n=ALL_LABELS.length;
  const end=new Date(ALL_LABELS[n-1]);
  const start=new Date(end); start.setDate(start.getDate()-days);
  const si=ALL_LABELS.findIndex(d=>new Date(d)>=start);
  if(si<0){MC?.resetZoom();return;}
  MC?.zoomScale('x',{min:si,max:n-1},'default');
}
function zoomIn(){MC?.zoom(1.3);}
function zoomOut(){MC?.zoom(0.75);}
function resetZoom(){
  MC?.resetZoom();
  document.querySelectorAll('.rbtn').forEach(b=>b.classList.remove('on'));
  document.querySelector('#range-btns .rbtn:last-child').classList.add('on');
}
function clearRangeBtns(){document.querySelectorAll('.rbtn').forEach(b=>b.classList.remove('on'));}

/* ── PROB TABLE ── */
function probTable(){
  if(!D) return;
  const hr=D.hit_rates, t=PT, hs=[1,2,3,4,5,6,8];
  const bands=hr?.[t]?.['1']||[];
  const pk=t==='sell'?'down_prob':'up_prob';
  let h=`<table class="ptbl"><thead><tr>
    <th>구간</th>${hs.map(x=>`<th>${x}주</th>`).join('')}
  </tr></thead><tbody>`;
  bands.forEach(b=>{
    h+=`<tr><td style="color:#fff;font-weight:700;font-size:14px">${b.band}<br>
      <span style="color:var(--mut);font-size:11px">${b.lo}~${b.hi}</span></td>`;
    hs.forEach(x=>{
      const hb=hr?.[t]?.[x]||[], m=hb.find(q=>q.lo===b.lo&&q.hi===b.hi), p=m?.[pk];
      if(p==null){h+=`<td style="color:var(--mut)">—</td>`;return;}
      const col=t==='sell'?(p>60?'var(--red)':p>45?'var(--yel)':'var(--grn)')
                          :(p>60?'var(--grn)':p>45?'var(--cyn)':'var(--mut)');
      const bg=t==='sell'?(p>60?'rgba(255,51,68,.2)':p>45?'rgba(255,184,48,.15)':'rgba(0,232,122,.12)')
                         :(p>60?'rgba(0,232,122,.2)':p>45?'rgba(0,212,255,.15)':'transparent');
      h+=`<td><span class="hcell" style="color:${col};background:${bg};border:1px solid ${col}40;font-size:13px">${p.toFixed(0)}%</span></td>`;
    });
    h+=`</tr>`;
  });
  document.getElementById('prob-tbl').innerHTML=h+'</tbody></table>';
}

/* ── HEATMAPS ── */
function heatmaps(hr){
  if(!hr) return;
  buildHM('sell-hm',hr.sell,'down_prob','sell');
  buildHM('buy-hm',hr.buy,'up_prob','buy');
}
function buildHM(id,data,pk,t){
  const el=document.getElementById(id); if(!el||!data) return;
  const hs=[1,2,3,4,5,6,8], bands=data['1']||[];
  let h=`<table class="ht"><thead><tr>
    <th>구간</th>${hs.map(x=>`<th>${x}주</th>`).join('')}<th>n</th>
  </tr></thead><tbody>`;
  bands.slice().reverse().forEach(b=>{
    h+=`<tr><td style="color:#fff;font-weight:700;font-size:14px">${b.band}<br>
      <span style="color:var(--mut);font-size:11px">${b.lo}~${b.hi}</span></td>`;
    hs.forEach(x=>{
      const hb=data[x]||[], m=hb.find(q=>q.lo===b.lo&&q.hi===b.hi), p=m?.[pk];
      if(p==null){h+=`<td style="color:var(--mut)">—</td>`;return;}
      const col=t==='sell'?(p>65?'var(--red)':p>50?'var(--yel)':'var(--grn)')
                          :(p>65?'var(--grn)':p>50?'var(--cyn)':'var(--sub)');
      const bg=t==='sell'?(p>65?'rgba(255,51,68,.22)':p>50?'rgba(255,184,48,.16)':'rgba(0,232,122,.12)')
                         :(p>65?'rgba(0,232,122,.22)':p>50?'rgba(0,212,255,.16)':'transparent');
      h+=`<td style="background:${bg}"><span style="color:${col};font-size:14px;font-weight:700">${p.toFixed(0)}%</span></td>`;
    });
    h+=`<td style="color:var(--mut);font-size:12px">${b.n}</td></tr>`;
  });
  el.innerHTML=h+'</tbody></table>';
}

/* ── POWER LIST ── */
function powList(stats){
  const el=document.getElementById('pow-list'); if(!el||!stats) return;
  const top=stats.slice(0,12), mx=Math.max(...top.map(s=>s.predictive_power||0));
  el.innerHTML=top.map(s=>{
    const pw=s.predictive_power||0, w=mx>0?(pw/mx*100):0;
    const c=s.score_type==='sell'?'var(--red)':'var(--grn)';
    const gw=s.score_type==='sell'?'rgba(255,51,68,.35)':'rgba(0,232,122,.35)';
    return `<div class="prow">
      <div class="pnm" title="${s.indicator}" style="color:#fff">
        ${s.indicator.replace(/_/g,' ')}
        <span style="font-size:11px;color:${c}">[${s.score_type==='sell'?'S':'B'}]</span>
      </div>
      <div class="pbar-t"><div class="pbar-f" style="width:${w}%;background:${c};box-shadow:0 0 5px ${gw}"></div></div>
      <div class="pval" style="color:${c}">${pw.toFixed(2)}</div>
    </div>`;
  }).join('');
}

init();
</script>
</body>
</html>
